# ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∏—Ä–∞ –≥–æ–≤–æ—Ä–∏–ª–∞ "—è –Ω–µ –≤–∏–∂—É —Ç–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å", —Ö–æ—Ç—è –ø–∞–º—è—Ç—å —Ä–∞–±–æ—Ç–∞–ª–∞.

**–ü—Ä–∏—á–∏–Ω–∞:** LangGraph nodes (`plan_node`, `respond_node`) –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ –≤ LLM —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∏—Å—Ç–æ—Ä–∏—é –∏–∑ `state.messages`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –¢–µ–ø–µ—Ä—å nodes –ø–µ—Ä–µ–¥–∞—é—Ç –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ LLM.

---

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–∞–≥ 1: –ü–ï–†–ï–ó–ê–ü–£–°–¢–ò–¢–¨ –ë–û–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
pkill -9 -f "kira telegram"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
kira telegram start --verbose
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Docker:**
```bash
docker-compose down
docker-compose up --build
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```bash
tail -f logs/telegram_bot.log | grep "üîç DEBUG"
```

**–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:**
```
INFO     üîç DEBUG: Calling LLM for planning with 3 messages (1 system + 2 conversation)
INFO     üîç DEBUG: Calling LLM for response with 4 messages (system + 2 conversation + context)
```

### –®–∞–≥ 3: –¢–µ—Å—Ç 1 - –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏

```
–í—ã: –ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ú–∞–∫—Å–∏–º
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ö–∏—Ä–∞ –æ—Ç–≤–µ—Ç–∏—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω–æ

```
–í—ã: –ö–∞–∫ –º–µ–Ω—è –∑–æ–≤—É—Ç?
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
–ö–∏—Ä–∞: –¢–µ–±—è –∑–æ–≤—É—Ç –ú–∞–∫—Å–∏–º!
```

‚úÖ **–ï—Å–ª–∏ –ö–∏—Ä–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç –∏–º—è - –ø–∞–º—è—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç!**

### –®–∞–≥ 4: –¢–µ—Å—Ç 2 - –í–æ–ø—Ä–æ—Å –æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ

```
–í—ã: –ö–∞–∫–∏–µ —É –º–µ–Ω—è –µ—Å—Ç—å –∑–∞–¥–∞—á–∏?
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ö–∏—Ä–∞ –ø–æ–∫–∞–∂–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á

```
–í—ã: –ß—Ç–æ —è —Å–ø—Ä–æ—Å–∏–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ?
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
–ö–∏—Ä–∞: –í –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ —Ç—ã —Å–ø—Ä–æ—Å–∏–ª "–ö–∞–∫–∏–µ —É –º–µ–Ω—è –µ—Å—Ç—å –∑–∞–¥–∞—á–∏?"
```

‚úÖ **–ï—Å–ª–∏ –ö–∏—Ä–∞ —Ü–∏—Ç–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

‚ùå **–ï—Å–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç "–Ω–µ –≤–∏–∂—É –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å" - –±–æ—Ç –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!**

### –®–∞–≥ 5: –¢–µ—Å—Ç 3 - –î–ª–∏–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥

```
–í—ã: –ö–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Ç–∞?
–ö–∏—Ä–∞: –°–µ–≥–æ–¥–Ω—è 10 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞
```

```
–í—ã: –°–æ–∑–¥–∞–π –∑–∞–¥–∞—á—É "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"
–ö–∏—Ä–∞: –û—Ç–ª–∏—á–Ω–æ, —Å–æ–∑–¥–∞–ª–∞ –∑–∞–¥–∞—á—É!
```

```
–í—ã: –û —á–µ–º —è —Å–ø—Ä–∞—à–∏–≤–∞–ª –≤–Ω–∞—á–∞–ª–µ –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞?
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
–ö–∏—Ä–∞: –í–Ω–∞—á–∞–ª–µ –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Ç—ã —Å–ø—Ä–∞—à–∏–≤–∞–ª –æ –¥–∞—Ç–µ - –∫–∞–∫–æ–µ —Å–µ–≥–æ–¥–Ω—è —á–∏—Å–ª–æ.
```

‚úÖ **–ï—Å–ª–∏ –ö–∏—Ä–∞ –ø–æ–º–Ω–∏—Ç –Ω–∞—á–∞–ª–æ - –ø–∞–º—è—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ!**

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### –õ–æ–≥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
grep "Calling LLM for planning" logs/telegram_bot.log | tail -5
```

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
Calling LLM for planning with 2 messages (1 system + 1 conversation)
                                             ‚Üë –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ–¥–Ω–µ–µ!
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
Calling LLM for planning with 5 messages (1 system + 4 conversation)
                                             ‚Üë –í–°–Ø –∏—Å—Ç–æ—Ä–∏—è!
```

### –õ–æ–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞

```bash
grep "Calling LLM for response" logs/telegram_bot.log | tail -5
```

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
Calling LLM for response with 2 messages (system + 1 conversation + context)
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
Calling LLM for response with 5 messages (system + 4 conversation + context)
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ë–æ—Ç –≤—Å–µ –µ—â–µ –Ω–µ –ø–æ–º–Ω–∏—Ç

**–°–∏–º–ø—Ç–æ–º:** –ö–∏—Ä–∞ –≥–æ–≤–æ—Ä–∏—Ç "–Ω–µ –≤–∏–∂—É –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
ps aux | grep "kira telegram"
# –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å - —É–±–∏—Ç—å:
pkill -9 -f "kira telegram"

# 2. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à Python (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
kira telegram start --verbose
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ—Ç debug –ª–æ–≥–æ–≤ —Å "Calling LLM for..."

**–°–∏–º–ø—Ç–æ–º:** –í –ª–æ–≥–∞—Ö –Ω–µ—Ç —Å—Ç—Ä–æ–∫ `üîç DEBUG: Calling LLM for...`

**–†–µ—à–µ–Ω–∏–µ:** –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω
grep "Calling LLM for planning" src/kira/agent/nodes.py

# –ï—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç - —Ñ–∞–π–ª –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å force rebuild
docker-compose down
docker-compose build --no-cache
docker-compose up
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
sqlite3 artifacts/conversations.db "SELECT COUNT(*) FROM conversations;"

# –ï—Å–ª–∏ 0 - –ø–∞–º—è—Ç—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
chmod 755 artifacts/
chmod 666 artifacts/conversations.db
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `Calling LLM for planning with N messages` –≥–¥–µ N > 2
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `Calling LLM for response with N messages` –≥–¥–µ N > 2
- [ ] –ö–∏—Ä–∞ –º–æ–∂–µ—Ç –Ω–∞–∑–≤–∞—Ç—å –≤–∞—à–µ –∏–º—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ
- [ ] –ö–∏—Ä–∞ –º–æ–∂–µ—Ç –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å
- [ ] –ö–∏—Ä–∞ –ø–æ–º–Ω–∏—Ç –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ –¥–∞–∂–µ –ø–æ—Å–ª–µ 5+ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (–∏–∑ –ë–î)

---

## üéØ –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞

```
[10:00] –í—ã: –ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ú–∞–∫—Å–∏–º
[10:00] –ö–∏—Ä–∞: –ü—Ä–∏–≤–µ—Ç, –ú–∞–∫—Å–∏–º! –†–∞–¥–∞ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?

[10:01] –í—ã: –ö–∞–∫–∏–µ —É –º–µ–Ω—è –µ—Å—Ç—å –∑–∞–¥–∞—á–∏?
[10:01] –ö–∏—Ä–∞: –£ —Ç–µ–±—è —Å–µ–π—á–∞—Å 16 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á! –•–æ—á–µ—à—å, —è —Ä–∞—Å—Å–∫–∞–∂—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ?

[10:02] –í—ã: –ö–∞–∫ –º–µ–Ω—è –∑–æ–≤—É—Ç?
[10:02] –ö–∏—Ä–∞: –¢–µ–±—è –∑–æ–≤—É—Ç –ú–∞–∫—Å–∏–º! üòä  ‚Üê ‚úÖ –ü–û–ú–ù–ò–¢ –ò–ú–Ø

[10:03] –í—ã: –ß—Ç–æ —è —Å–ø—Ä–æ—Å–∏–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ?
[10:03] –ö–∏—Ä–∞: –í –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ —Ç—ã —Å–ø—Ä–æ—Å–∏–ª "–ö–∞–∫ –º–µ–Ω—è –∑–æ–≤—É—Ç?" ‚Üê ‚úÖ –ü–û–ú–ù–ò–¢ –í–û–ü–†–û–°

[10:04] –í—ã: –ê –æ —á–µ–º —è —Å–ø—Ä–∞—à–∏–≤–∞–ª —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º?
[10:04] –ö–∏—Ä–∞: –°–∞–º—ã–º –ø–µ—Ä–≤—ã–º —Ç—ã –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è - —Å–∫–∞–∑–∞–ª, —á—Ç–æ —Ç–µ–±—è –∑–æ–≤—É—Ç –ú–∞–∫—Å–∏–º ‚Üê ‚úÖ –ü–û–ú–ù–ò–¢ –ù–ê–ß–ê–õ–û
```

**–ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫ - –í–°–Å –†–ê–ë–û–¢–ê–ï–¢ –ò–î–ï–ê–õ–¨–ù–û! üéâ**

---

## üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ

### –î–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```python
# plan_node
messages = [
    Message(role="system", content=system_prompt),
    Message(role="user", content=last_user_message),  # ‚Üê –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π!
]
```

### –ü–æ—Å–ª–µ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```python
# plan_node
messages = [Message(role="system", content=system_prompt)]
for msg in state.messages:  # ‚Üê –í–°–Ø –∏—Å—Ç–æ—Ä–∏—è!
    messages.append(Message(role=msg["role"], content=msg["content"]))
```

–¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è `respond_node`.

---

## üÜò –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ

–°–æ–±–µ—Ä–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏ —Å–æ–∑–¥–∞–π—Ç–µ issue:

```bash
# –°–æ–±–µ—Ä–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
echo "=== MEMORY FIX DIAGNOSTIC ===" > memory-fix-debug.txt

echo "\n1. Latest logs with LLM calls:" >> memory-fix-debug.txt
grep -A 2 "Calling LLM" logs/telegram_bot.log | tail -20 >> memory-fix-debug.txt

echo "\n2. Database content:" >> memory-fix-debug.txt
sqlite3 artifacts/conversations.db "SELECT * FROM conversations LIMIT 5;" >> memory-fix-debug.txt

echo "\n3. nodes.py checksum:" >> memory-fix-debug.txt
md5sum src/kira/agent/nodes.py >> memory-fix-debug.txt

echo "\n4. Process info:" >> memory-fix-debug.txt
ps aux | grep kira >> memory-fix-debug.txt

cat memory-fix-debug.txt
```

---

**TL;DR:**

1. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (`pkill -9 -f "kira telegram" && kira telegram start --verbose`)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `Calling LLM for ... with N messages`)
3. ‚úÖ –¢–µ—Å—Ç: "–ö–∞–∫ –º–µ–Ω—è –∑–æ–≤—É—Ç?" –ø–æ—Å–ª–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
4. ‚úÖ –¢–µ—Å—Ç: "–ß—Ç–æ —è —Å–ø—Ä–æ—Å–∏–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å–µ?"

**–ï—Å–ª–∏ –æ–±–∞ —Ç–µ—Å—Ç–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç - –ø–∞–º—è—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ**

